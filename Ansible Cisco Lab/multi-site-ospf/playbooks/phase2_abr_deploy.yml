---
- name: "PHASE 2: Deploy OSPF on ABR Routers (R5, R8) - Requires Phase 1 Connectivity"
  hosts: phase2_routers
  gather_facts: false
  
  handlers:
    - name: save config
      cisco.ios.ios_config:
        save_when: always

  pre_tasks:
    - name: Test connectivity to ABR routers
      wait_for:
        host: "{{ ansible_host }}"
        port: 22
        timeout: 10
      delegate_to: localhost
      
    - name: Display reachability confirmation
      debug:
        msg: "Successfully reached {{ inventory_hostname }} at {{ ansible_host }} via OSPF routing!"

  tasks:
    - name: Gather device facts
      cisco.ios.ios_facts:
        gather_subset: min
      
    - name: Display router info
      debug:
        msg: "Configuring {{ inventory_hostname }} - IOS {{ ansible_net_version }}"

    - name: Apply base interface configuration (ABR links)
      include_role:
        name: base_interfaces
      tags: ['interfaces', 'base']

    - name: Apply OSPF configuration (with inter-area routing)
      include_role:
        name: ospf
      tags: ['ospf', 'routing']

    - name: Verify ABR status
      cisco.ios.ios_command:
        commands:
          - show ip ospf border-routers
      register: abr_status
      tags: ['verify']

    - name: Display ABR information
      debug:
        msg: "{{ abr_status.stdout_lines[0] }}"
      tags: ['verify']